# 主色调数据库管理功能实现记录

**日期**: 2026-02-11  
**功能**: 在设置面板的储存栏中添加主色调数据库查询和管理功能

**更新日期**: 2026-02-12  
**更新内容**: 修复统计信息同步问题、添加重试状态显示、图片预览错误处理、自动刷新功能

---

## 功能概述

在设置面板的储存栏（storage category）中添加了主色调数据库管理功能，包括：
1. 数据库统计信息展示（总记录数、状态分布、文件大小）
2. 错误文件列表查看
3. 对错误文件重新生成主色调的功能
4. **损坏图片管理功能**（新增）：查看、预览、批量删除损坏的图片文件
5. **自动清理无效记录**（新增）：刷新时自动清理已不存在的文件记录
6. **重试状态显示**（新增）：显示"正在重试"状态直到处理完成
7. **图片预览错误处理**（新增）：损坏文件显示友好错误提示
8. **自动刷新**（新增）：进入设置窗口和储存分类时自动刷新

---

## 修改文件清单

### 1. 后端 Rust 文件

#### `src-tauri/src/color_db.rs`
新增以下函数：

- `get_error_files_count(conn: &mut Connection) -> Result<usize>`  
  获取错误文件数量

- `get_error_files(conn: &mut Connection) -> Result<Vec<(String, i64)>>`  
  获取所有错误文件列表（包含文件路径和更新时间戳）

- `reset_error_files_to_pending(conn: &mut Connection, file_paths: Option<&[String]>) -> Result<usize>`  
  将错误文件重置为待处理状态，支持批量重置或全部重置

- `delete_error_files(conn: &mut Connection, file_paths: &[String]) -> Result<usize>`  
  从数据库中删除错误文件记录

- `cleanup_nonexistent_error_files(conn: &mut Connection) -> Result<Vec<(String, i64)>>`（新增）  
  清理不存在的错误文件记录，返回实际存在的错误文件列表
  - 获取所有状态为 error 的文件记录
  - 检查每个文件是否实际存在于磁盘
  - 自动删除不存在文件的记录
  - 返回实际存在的错误文件列表

#### `src-tauri/src/main.rs`
新增以下 Tauri 命令：

- `get_color_db_stats() -> Result<serde_json::Value, String>`  
  获取数据库统计信息（总记录数、各状态数量、文件大小）

- `get_color_db_error_files() -> Result<Vec<serde_json::Value>, String>`  
  获取错误文件列表（自动清理不存在的文件记录）

- `retry_color_extraction(file_paths: Option<Vec<String>>) -> Result<usize, String>`  
  重新处理错误文件

- `delete_color_db_error_files(file_paths: Vec<String>) -> Result<usize, String>`  
  从数据库中删除错误文件记录

并在 `generate_handler!` 宏中注册了这四个命令。

---

### 2. 前端 API 文件

#### `src/api/tauri-bridge.ts`
新增以下内容：

**接口定义**:
```typescript
interface ColorDbStats {
  total: number;
  extracted: number;
  error: number;
  pending: number;
  processing: number;
  dbSize: number;
  walSize: number;
}

interface ColorDbErrorFile {
  path: string;
  timestamp: number;
}
```

**API 函数**:
- `getColorDbStats(): Promise<ColorDbStats | null>`  
  获取主色调数据库统计信息

- `getColorDbErrorFiles(): Promise<ColorDbErrorFile[]>`  
  获取错误文件列表（自动清理不存在的文件记录）

- `retryColorExtraction(filePaths?: string[]): Promise<number>`  
  重新处理错误文件

- `deleteColorDbErrorFiles(filePaths: string[]): Promise<number>`  
  从数据库中删除错误文件记录

---

### 3. 前端组件文件

#### `src/components/SettingsModal.tsx`

**新增导入**:
```typescript
import { AlertCircle, ChevronDown, ChevronUp, Play, Image, Eye, Trash, FolderOpen, X } from 'lucide-react';
import { getColorDbStats, getColorDbErrorFiles, retryColorExtraction, deleteColorDbErrorFiles, ColorDbStats, ColorDbErrorFile, getAssetUrl, deleteFile } from '../api/tauri-bridge';
```

**新增状态变量**:
```typescript
const [colorDbStats, setColorDbStats] = useState<ColorDbStats | null>(null);
const [errorFiles, setErrorFiles] = useState<ColorDbErrorFile[]>([]);
const [showErrorFiles, setShowErrorFiles] = useState(false);
const [isLoadingStats, setIsLoadingStats] = useState(false);
const [isRetrying, setIsRetrying] = useState(false);
const [retrySuccess, setRetrySuccess] = useState<string | null>(null);

// 损坏图片管理状态
const [previewFile, setPreviewFile] = useState<ColorDbErrorFile | null>(null);
const [previewError, setPreviewError] = useState(false);
const [selectedFiles, setSelectedFiles] = useState<Set<string>>(new Set());
const [isDeleting, setIsDeleting] = useState(false);
const [deleteSuccess, setDeleteSuccess] = useState<string | null>(null);
const [viewMode, setViewMode] = useState<'list' | 'grid'>('list');
```

**新增函数**:
- `loadColorDbStats()` - 加载数据库统计信息
- `loadErrorFiles()` - 加载错误文件列表
- `handleRetryErrors(specificFiles?: string[])` - 处理重新生成请求（带轮询状态检测）
- `formatFileSize(bytes: number): string` - 格式化文件大小
- `toggleFileSelection(path: string)` - 切换文件选择状态
- `toggleSelectAll()` - 全选/取消全选
- `handleDeleteSelected()` - 批量删除选中的文件
- `handleDeleteSingle(file: ColorDbErrorFile)` - 删除单个文件
- `openInExplorer(path: string)` - 在文件管理器中打开
- `openPreview(file: ColorDbErrorFile)` - 打开预览并重置错误状态（新增）
- `closePreview()` - 关闭预览并重置错误状态（新增）

**新增 UI 区域**:
在储存栏的数据备份 section 后面添加了主色调数据库管理 section，包括：
- 标题栏（带刷新按钮）
- 统计卡片（总记录数、数据库大小）
- 状态分布可视化（进度条显示各状态占比）
- 错误文件管理区域（警告提示、全部重试按钮、错误文件列表）
- **损坏图片管理功能**：
  - 列表/网格视图切换
  - 文件选择（支持批量选择）
  - 图片预览模态框
  - 批量删除功能
  - 在文件管理器中打开

**图片预览模态框**:
- 显示损坏图片的大图预览
- 显示文件路径和修改时间
- 提供在文件管理器中打开按钮
- 提供删除按钮
- 点击背景或关闭按钮退出预览
- **图片加载错误处理**（新增）：
  - 使用 `previewError` 状态跟踪加载状态
  - 加载失败时显示图片图标和错误提示
  - 错误提示："当前不支持该格式，或文件已损坏。"

**useEffect**:
- 当切换到 storage 页面时自动加载统计信息
- **组件挂载时自动刷新**（新增）：如果在 storage 页面，自动刷新统计信息

**重试状态处理**（新增）：
- 点击"全部重试"后显示"正在重试..."状态（黄色背景，旋转图标）
- 使用轮询机制检测处理状态（每2秒检查一次）
- 当 `pending === 0 && processing === 0` 时显示"所有文件处理正常"

**刷新逻辑优化**（新增）：
- 刷新按钮先调用 `loadErrorFiles()` 清理不存在的文件记录
- 然后再调用 `loadColorDbStats()` 获取更新后的统计信息
- 确保统计信息和文件列表同步

---

### 4. 国际化文件

#### `src/utils/translations.ts`

在中文 (`zh`) 和英文 (`en`) 的 `settings` 对象中添加了以下翻译键：

```typescript
settings: {
  // ... 原有翻译键
  colorDbTitle: '主色调数据库', // Color Database
  colorDbTotalRecords: '总记录数', // Total Records
  colorDbFileSize: '数据库大小', // Database Size
  colorDbStatusDistribution: '状态分布', // Status Distribution
  colorDbExtracted: '已提取', // Extracted
  colorDbPending: '待处理', // Pending
  colorDbProcessing: '处理中', // Processing
  colorDbErrors: '错误', // Errors
  colorDbHasErrors: '发现 {count} 个错误文件', // Found {count} error files
  colorDbRetryAll: '全部重试', // Retry All
  colorDbRetrySingle: '重试此文件', // Retry This File
  colorDbRetrying: '正在重试...', // Retrying...（新增）
  colorDbRetrySuccess: '已成功重置 {count} 个文件', // Successfully reset {count} files
  colorDbAllGood: '所有文件处理正常', // All files processed successfully
  colorDbNoData: '暂无数据库信息', // No database information available
  
  // 损坏图片管理相关
  colorDbDeleteConfirm: '确定要删除选中的 {count} 个文件吗？此操作不可恢复。',
  colorDbDeleteSingleConfirm: '确定要删除文件 "{name}" 吗？此操作不可恢复。',
  colorDbDeleteSuccess: '已成功删除 {count} 个文件',
  colorDbDeleteFailed: '删除文件失败',
  deleteSelected: '删除选中',
  selectAll: '全选', // Select All（新增）
  filePath: '文件路径',
  previewError: '当前不支持该格式，或文件已损坏。', // This format is not supported, or the file is corrupted.（新增）
  
  refresh: '刷新', // Refresh
  hide: '隐藏', // Hide
  show: '显示', // Show
  loading: '加载中...' // Loading...
}
```

---

## 用户交互流程

### 基础功能
1. **打开设置面板** → 自动刷新主色调数据库统计信息（如果在储存栏）
2. **点击储存栏** → 自动刷新主色调数据库统计信息
3. **查看统计**:
   - 总记录数
   - 数据库文件大小
   - 各状态（已提取、待处理、处理中、错误）的数量和占比
4. **错误文件管理**（如果有错误）:
   - 显示红色警告区域，提示错误文件数量
   - 点击"全部重试"按钮重新处理所有错误文件
   - 点击"显示"按钮展开错误文件列表
   - 在列表中可以单独重试某个文件
5. **重新生成后**:
   - 文件状态变为 pending
   - 显示"正在重试..."状态（黄色背景，旋转图标）
   - 后台工作线程自动处理
   - 处理完成后显示"所有文件处理正常"
   - 显示成功提示消息

### 损坏图片管理功能
1. **查看错误文件列表**:
   - 点击"显示"按钮展开错误文件列表
   - 可以在列表视图和网格视图间切换
   - **刷新时自动清理**已不存在的文件记录
2. **选择文件**:
   - 使用复选框选择单个文件
   - 使用"全选"按钮批量选择
3. **预览图片**:
   - 点击预览按钮（眼睛图标）查看大图
   - 在预览模态框中可以看到文件完整路径
   - **损坏文件显示错误提示**："当前不支持该格式，或文件已损坏。"
4. **删除文件**:
   - 单个删除：点击文件行的删除按钮
   - 批量删除：选择多个文件后点击"删除选中"按钮
   - 删除前会弹出确认对话框
   - 删除成功后显示提示消息
5. **在文件管理器中打开**:
   - 点击文件夹图标可以在系统文件管理器中定位到该文件

---

## 技术实现细节

### 数据库查询
- 使用 SQLite 查询 `dominant_colors` 表
- 按 `status` 字段统计各状态数量
- 错误文件按 `updated_at` 降序排列

### 文件重置逻辑
- 将 `status` 从 `error` 改为 `pending`
- 更新 `updated_at` 时间戳
- 支持批量重置（指定文件路径列表）或全部重置

### 文件删除逻辑
- 物理删除文件：调用 Rust 后端的 `delete_file` 命令
- 删除数据库记录：调用 `delete_color_db_error_files` 命令
- 同时删除 `dominant_colors` 和 `image_color_indices` 表中的记录
- 支持批量删除，提高操作效率

### 自动清理无效记录（新增）
- 在 `get_color_db_error_files` 命令中调用 `cleanup_nonexistent_error_files`
- 检查每个错误文件是否实际存在于磁盘
- 自动删除不存在文件的记录
- 返回实际存在的错误文件列表

### 重试状态检测（新增）
- 使用轮询机制检测处理状态
- 每2秒检查一次 `pending` 和 `processing` 数量
- 当两者都为0时，认为处理完成
- 显示"所有文件处理正常"状态

### 图片预览错误处理（新增）
- 使用 `previewError` 状态跟踪图片加载状态
- `img` 标签的 `onError` 事件设置 `previewError = true`
- 条件渲染：加载成功显示图片，加载失败显示错误提示
- 打开新预览时重置 `previewError` 状态

### 自动刷新（新增）
- 组件挂载时检查是否在 storage 页面，如果是则自动刷新
- 切换到 storage 页面时自动刷新
- 刷新时先清理无效记录，再获取统计信息

### 状态颜色
- 已提取: 绿色 (`bg-green-500`)
- 待处理: 蓝色 (`bg-blue-500`)
- 处理中: 黄色 (`bg-yellow-500`)
- 错误: 红色 (`bg-red-500`)
- 正在重试: 黄色背景 (`bg-yellow-50`, `border-yellow-200`)

### 错误处理
- API 调用失败时返回空数组或 null
- 控制台输出错误日志
- UI 显示加载状态和空状态提示
- 删除操作有确认对话框，防止误操作
- 图片加载失败显示友好错误提示

---

## 注意事项

1. **循环引用问题**: 在添加翻译键时，不能使用 `...(translations as any).zh.settings` 的方式展开，因为会导致循环引用错误。应该直接将新键添加到原有的 `settings` 对象中。

2. **文件路径处理**: 在重置错误文件时，需要将 Windows 路径分隔符 `\` 转换为 `/` 进行匹配。

3. **时间戳转换**: 数据库中存储的是 Unix 时间戳（秒），前端显示时需要转换为毫秒并格式化为本地时间字符串。

4. **自动刷新**: 现在进入设置窗口和储存分类时会自动刷新统计信息。

5. **删除确认**: 删除文件操作不可恢复，因此添加了确认对话框，避免用户误操作。

6. **图片预览**: 损坏的图片会显示友好的错误提示，而不是空白区域。

7. **统计信息同步**: 刷新时会先清理不存在的文件记录，确保统计信息和文件列表一致。

8. **重试状态**: 点击"全部重试"后会显示"正在重试..."状态，直到后台处理完成。

---

## 后续优化建议

1. ~~添加自动刷新功能（定时轮询）~~（已实现：进入设置时自动刷新）
2. 添加导出错误文件列表功能
3. 添加批量选择错误文件进行重试的功能
4. 显示错误原因（如果数据库中存储了错误信息）
5. 添加数据库压缩/清理功能
6. 添加错误文件导出功能（将损坏文件移动到其他目录）
7. 添加图片修复建议（如使用图片修复工具）
