# 参考模式 (Reference Mode) 实现总结

## 会话日期
2026-02-09 - 2026-02-10

## 需求概述
在图片对比组件 `ImageComparer.tsx` 中新增"参考模式"，该模式具有以下特性：
1. 在顶部工具栏吸附功能按钮右边新增进入参考模式的按钮
2. 进入参考模式时：
   - 关闭左侧面板与右侧详情面板，并隐藏这两个切换按钮
   - 软件窗口始终在前
   - 解除软件窗口 1280*800 的限制，更改为最小缩放到 200*200
   - 隐藏顶部标签栏 (TabBar) 和图片对比组件的顶部工具栏
3. 鼠标悬停交互：
   - 当鼠标悬停在窗口顶部区域时，TabBar 和工具栏同时显示
   - 鼠标离开后延迟 300ms 同时隐藏
   - 两者同步显示/隐藏，保持一致的交互体验

## 已完成的修改

### 1. Rust 后端 (`src-tauri/src/main.rs`)
- 添加 `set_window_min_size` 命令，支持动态设置窗口最小尺寸
- 将命令注册到 `invoke_handler`

### 2. Tauri 配置 (`src-tauri/tauri.conf.json`)
- 保持初始最小窗口尺寸为 1280x800（软件启动时的默认限制）

### 3. 前端 API (`src/api/tauri-bridge.ts`)
- 添加 `setWindowMinSize` 函数封装，用于调用 Rust 后端的 `set_window_min_size` 命令

### 4. 图片对比组件 (`src/components/ImageComparer.tsx`)

#### 新增状态与引用
- `isReferenceMode`: 参考模式状态
- `layoutPropRef`: 使用 ref 存储 layoutProp，避免重新渲染问题
- `onLayoutToggleRef`: 使用 ref 存储 onLayoutToggle 回调
- `onReferenceModeChangeRef`: 使用 ref 存储 onReferenceModeChange 回调

#### 新增函数
- `toggleReferenceMode`: 切换参考模式
  - 切换 `isReferenceMode` 状态
  - 调用 `onReferenceModeChange` 通知父组件显示/隐藏 TabBar
  - 调用 `window.setAlwaysOnTop()` 设置窗口始终在前
  - 根据模式设置窗口最小尺寸（200x200 或 1280x800）
  - 使用 `setTimeout` 延迟关闭侧边栏，避免立即触发重新渲染

#### UI 修改
- 在工具栏吸附按钮右侧添加参考模式切换按钮（Eye 图标）
- 根据 `isReferenceMode` 状态条件渲染侧边栏和详情面板切换按钮
- 添加键盘快捷键 `R` 切换参考模式

#### 清理逻辑
- 组件卸载时恢复 TabBar 显示
- 取消窗口始终在前设置
- 恢复窗口最小尺寸为 1280x800

### 5. TabBar 组件 (`src/components/TabBar.tsx`)

#### 新增 Props
- `isReferenceMode`: 是否处于参考模式
- `onHoverChange`: 悬停状态变化回调，通知父组件鼠标是否悬停在顶部区域

#### 修改
- 添加 `isHoveringTabBar` 状态追踪鼠标悬停
- 实现 `handleMouseEnter` 和 `handleMouseLeave` 处理函数
- 使用 CSS `translate-y` 变换实现平滑的显示/隐藏动画
- 参考模式下使用 `absolute` 定位，普通模式下使用 `relative` 定位
- 添加 4px 高的悬停检测区域，方便鼠标从上方移入

### 6. 主应用组件 (`src/App.tsx`)

#### 新增状态
- `isReferenceMode`: 控制参考模式状态
- `isHoveringTopBar`: 追踪鼠标是否悬停在顶部区域
- `handleReferenceModeChange`: 使用 `useCallback` 创建稳定的回调函数
- `handleTopBarHoverChange`: 处理 TabBar 悬停状态变化

#### 修改
- TabBar 始终渲染，通过 `isReferenceMode` 和 `isHoveringTopBar` 控制显示/隐藏
- 将 `isReferenceMode` 和 `isHoveringTopBar` 传递给 `ImageComparer`
- 在 `ImageComparer` 的 `onClose` 和 `onCloseTab` 回调中恢复 `isReferenceMode` 为 false

## 已知问题

### TabBar 闪烁问题 ✅ 已修复
**现象**: 进入参考模式时，TabBar 会闪烁一下（突然消失然后又再次出现）

**原因**: `ImageComparer` 组件的 `useEffect` 清理函数依赖了 `sessionFiles` 和 `isReferenceMode`，导致每次这些值变化时都会执行清理函数，重置参考模式状态。

**解决方案**: 将清理逻辑分成两个独立的 `useEffect`：
1. 一个处理 `sessionFiles` 的清理（blob URL 释放）
2. 另一个专门处理参考模式的清理，使用空依赖数组 `[]`，只在组件真正卸载时执行

### 顶部工具栏与 TabBar 同步显示/隐藏 ✅ 已实现
**需求**: 进入参考模式时，顶部工具栏和 TabBar 应该同步显示/隐藏

**实现方案**:
1. TabBar 通过 `onHoverChange` 回调通知父组件悬停状态
2. App 组件维护统一的 `isHoveringTopBar` 状态
3. 将 `isReferenceMode` 和 `isHoveringTopBar` 通过 props 传递给 `ImageComparer`
4. `ImageComparer` 根据这些 props 同步控制工具栏的显示/隐藏

## 文件修改列表

### 新增/修改的文件
1. `src-tauri/src/main.rs` - 添加 `set_window_min_size` 命令
2. `src-tauri/tauri.conf.json` - 配置窗口最小尺寸
3. `src/api/tauri-bridge.ts` - 添加 `setWindowMinSize` 函数
4. `src/components/ImageComparer.tsx` - 实现参考模式功能，添加工具栏同步显示/隐藏
5. `src/components/TabBar.tsx` - 添加悬停检测和动画效果
6. `src/App.tsx` - 控制 TabBar 和工具栏同步显示/隐藏

## 下一步工作
1. ~~修复 TabBar 闪烁问题~~ ✅ 已完成
2. ~~实现顶部工具栏与 TabBar 同步显示/隐藏~~ ✅ 已完成
3. 测试参考模式在各种场景下的稳定性
4. 考虑添加更多参考模式的特性（如透明度调节、置顶/取消置顶的动画效果等）

## 相关代码片段

### 切换参考模式的核心逻辑
```typescript
const toggleReferenceMode = useCallback(async () => {
  const newMode = !isReferenceMode;
  setIsReferenceMode(newMode);
  onReferenceModeChangeRef.current?.(newMode);

  try {
    const window = getCurrentWindow();
    await window.setAlwaysOnTop(newMode);

    if (newMode) {
      // 进入参考模式
      await setWindowMinSize(200, 200);
      setTimeout(() => {
        const currentLayout = layoutPropRef.current;
        const currentOnLayoutToggle = onLayoutToggleRef.current;
        if (currentLayout?.isSidebarVisible) {
          currentOnLayoutToggle?.('sidebar');
        }
        if (currentLayout?.isMetadataVisible) {
          currentOnLayoutToggle?.('metadata');
        }
      }, 50);
    } else {
      // 退出参考模式
      await setWindowMinSize(1280, 800);
    }
  } catch (error) {
    console.error('Failed to toggle reference mode:', error);
  }
}, [isReferenceMode]);
```

### TabBar 悬停检测与动画
```tsx
// TabBar 组件中使用 translate-y 控制显示/隐藏
<div
  className={`flex flex-col z-[200] transition-transform duration-200 ease-out ${
    isReferenceMode ? 'absolute top-0 left-0 right-0' : 'relative'
  } ${
    shouldShowTabBar ? 'translate-y-0' : '-translate-y-full'
  }`}
  onMouseEnter={handleMouseEnter}
  onMouseLeave={handleMouseLeave}
>
  {/* 悬停检测区域 */}
  {isReferenceMode && !isHoveringTabBar && (
    <div
      className="absolute -bottom-4 left-0 right-0 h-4 cursor-pointer"
      onMouseEnter={handleMouseEnter}
    />
  )}
</div>
```

### 顶部工具栏同步显示/隐藏
```tsx
// ImageComparer 组件中根据 props 控制工具栏
<div
  className={`... transition-transform duration-200 ease-out h-14 ${
    isReferenceMode ? 'absolute left-0 right-0 top-0 z-[150]' : 'relative z-10'
  } ${
    isReferenceMode ? (shouldShowToolbar ? 'translate-y-0' : '-translate-y-[calc(100%+41px)]') : ''
  }`}
>
```

### App 组件中状态传递
```tsx
// 统一的悬停状态管理
const [isHoveringTopBar, setIsHoveringTopBar] = useState(false);

<TabBar
  isReferenceMode={isReferenceMode}
  onHoverChange={handleTopBarHoverChange}
/>

<ImageComparer
  isReferenceMode={isReferenceMode}
  isHoveringTopBar={isHoveringTopBar}
/>
```
