# 右键菜单图片对比功能增强 - 实现记录

**日期**: 2026-02-11  
**功能描述**: 为右键菜单的"图片对比"功能添加二级菜单支持，允许用户将图片添加到现有画布或新建画布

---

## 修改文件列表

1. `src/components/ContextMenu.tsx` - 右键菜单组件
2. `src/components/ImageComparer.tsx` - 图片对比组件
3. `src/App.tsx` - 主应用组件
4. `src/hooks/useNavigation.ts` - 导航 hook
5. `src/utils/translations.ts` - 翻译文件

---

## 本次会话新增修改（2026-02-11）

### useNavigation.ts

#### 新增画布名称生成逻辑

在 `handleOpenCompareInNewTab` 函数中添加 `sessionName` 生成：

```typescript
const handleOpenCompareInNewTab = useCallback((imageIds: string[]) => {
  // 生成新的画布名称
  const generateCanvasName = () => {
    const existingNames = state.tabs
      .filter(tab => tab.isCompareMode)
      .map(tab => tab.sessionName)
      .filter((name): name is string => !!name);

    let maxNum = 0;
    existingNames.forEach(name => {
      const match = name.match(/^画布(\d+)$/);
      if (match) {
        const num = parseInt(match[1], 10);
        if (num > maxNum) maxNum = num;
      }
    });

    return `画布${String(maxNum + 1).padStart(2, '0')}`;
  };

  const newTab: TabState = {
    ...DUMMY_TAB,
    id: Math.random().toString(36).substr(2, 9),
    folderId: (state.tabs.find(t => t.id === state.activeTabId) || DUMMY_TAB).folderId,
    selectedFileIds: imageIds,
    isCompareMode: true,
    sessionName: generateCanvasName(),  // 新增
    // ...
  };
  // ...
}, [setState, state.tabs, state.activeTabId]);
```

### ImageComparer.tsx

#### 新增 Props

```typescript
interface ImageComparerProps {
  // ... 其他 props
  onSelectedFileIdsChange?: (ids: string[]) => void;  // 新增
}
```

#### 鼠标交互逻辑修改

在图片对比模式下，所有鼠标交互都不再调用 `onSelect`，避免改变父组件的 `selectedFileIds`：

**handleMouseDown**: 注释掉 `onSelect?.(clickedId)` 调用
**handleMouseUp**: 注释掉 `onSelect?.(ids[ids.length - 1])` 和 `onSelect?.('')` 调用
**handleContextMenu**: 注释掉 `onSelect?.(targetId)` 调用

#### 添加/移除图片时通知父组件

**handleAddImages**:
```typescript
const handleAddImages = (newIds: string[]) => {
  // ...
  const updatedIds = [...internalSelectedIds, ...uniqueNewIds];
  setInternalSelectedIds(updatedIds);
  // ...
  // 通知父组件 selectedFileIds 已更改
  onSelectedFileIdsChange?.(updatedIds);
  // ...
};
```

**handleRemoveImage**:
```typescript
const handleRemoveImage = () => {
  // ...
  const updatedIds = internalSelectedIds.filter(i => !idsToRemove.includes(i));
  setInternalSelectedIds(updatedIds);
  // ...
  // 通知父组件 selectedFileIds 已更改
  onSelectedFileIdsChange?.(updatedIds);
};
```

### App.tsx

#### ImageComparer 组件调用修改

新增 `onSelectedFileIdsChange` 回调：

```typescript
<ImageComparer
  // ... 其他 props
  onSelectedFileIdsChange={(ids) => updateTabById(tab.id, { selectedFileIds: ids })}
/>
```

### ContextMenu.tsx

#### 二级菜单悬停逻辑优化

添加延迟关闭机制：

```typescript
const [compareSubmenuOpen, setCompareSubmenuOpen] = useState(false);
const compareMenuTimeoutRef = useRef<NodeJS.Timeout | null>(null);

// 打开二级菜单（带延迟关闭保护）
const openCompareSubmenu = () => {
  if (compareMenuTimeoutRef.current) {
    clearTimeout(compareMenuTimeoutRef.current);
    compareMenuTimeoutRef.current = null;
  }
  setCompareSubmenuOpen(true);
};

// 关闭二级菜单（带延迟）
const closeCompareSubmenu = () => {
  compareMenuTimeoutRef.current = setTimeout(() => {
    setCompareSubmenuOpen(false);
  }, 150); // 150ms 延迟
};
```

---

## 详细修改内容

### 1. ContextMenu.tsx

#### 新增 Props
```typescript
tabs: TabState[];  // 所有标签页状态
handleAddToCompareCanvas: (tabId: string, imageIds: string[]) => void;  // 添加图片到现有画布
```

#### 新增状态
```typescript
const [compareSubmenuOpen, setCompareSubmenuOpen] = useState(false);  // 控制二级菜单显示
```

#### 核心逻辑修改

**图片对比菜单项逻辑重构**:

1. **无图片对比标签页时**: 保持原有行为，点击后直接创建新画布（需要至少2张图片）

2. **有图片对比标签页时**: 显示二级菜单，包含:
   - 现有画布列表: 显示 "添加到 '画布XX' 当前数量/24"
   - 分隔线
   - "新建画布" 选项

**二级菜单定位逻辑**:
- 使用 `fixed` 定位避免被父容器的 `overflow-y-auto` 裁剪
- 动态计算位置，相对于"图片对比"菜单项定位
- 超出屏幕右侧时显示在左侧
- 超出屏幕底部时向上调整

**二级菜单交互**:
- 鼠标悬停"图片对比"菜单项时显示二级菜单
- 鼠标移出时关闭二级菜单
- 二级菜单本身也有悬停事件，确保鼠标移动到二级菜单时保持打开

#### 关键代码片段

```typescript
// 二级菜单容器
<div
  className="relative group/compare"
  onMouseEnter={() => setCompareSubmenuOpen(true)}
  onMouseLeave={() => setCompareSubmenuOpen(false)}
  ref={(el) => {
    if (el) {
      (el as any).__compareMenuItemRef = el;
    }
  }}
>
  {/* 菜单项内容 */}
  
  {/* 二级菜单 */}
  {compareSubmenuOpen && (
    <div
      className="fixed bg-white dark:bg-gray-800 ..."
      ref={(el) => {
        if (el && contextMenu.visible) {
          // 动态计算位置
          const menuItemEl = (el?.parentElement as any)?.__compareMenuItemRef;
          if (menuItemEl) {
            const menuItemRect = menuItemEl.getBoundingClientRect();
            let x = menuItemRect.right + 4;
            let y = menuItemRect.top;
            // 边界检测...
            el.style.left = `${x}px`;
            el.style.top = `${y}px`;
          }
        }
      }}
    >
      {/* 画布列表和新建选项 */}
    </div>
  )}
</div>
```

---

### 2. ImageComparer.tsx

#### useEffect 修改

**原逻辑**:
```typescript
// 只初始化一次，不响应 selectedFileIds 变化
useEffect(() => {
  if (!initializedRef.current) {
    initializedRef.current = true;
    // 初始化逻辑...
  }
}, []);
```

**新逻辑**:
```typescript
// 初始化并响应 selectedFileIds 变化
useEffect(() => {
  if (!initializedRef.current) {
    initializedRef.current = true;
  }
  // 当 selectedFileIds 变化时，更新内部状态
  setInternalSelectedIds(prevIds => {
    const newIds = selectedFileIds.slice();
    // 排序逻辑...
    return sortedIds;
  });
  setZOrderIds(selectedFileIds.slice());
  imagesCache.current.clear();
  setLoadedCount(0);
  onReadyCalledRef.current = false;
}, [selectedFileIds]); // 只监听 selectedFileIds
```

**修改原因**: 当用户通过右键菜单添加图片到现有画布时，需要组件能够响应 `selectedFileIds` prop 的变化并更新显示。

---

### 3. App.tsx

#### 新增函数

```typescript
// 添加图片到现有的图片对比画布
const handleAddToCompareCanvas = useCallback((tabId: string, imageIds: string[]) => {
  const targetTab = state.tabs.find(t => t.id === tabId);
  if (!targetTab || !targetTab.isCompareMode) return;

  const currentCount = targetTab.selectedFileIds.length;
  const maxCount = 24;
  const remainingSpace = maxCount - currentCount;

  if (remainingSpace <= 0) {
    showToast(t('context.canvasFull') || '画布已满');
    return;
  }

  // 只添加能容纳的图片
  const idsToAdd = imageIds.slice(0, remainingSpace);
  const actuallyAdded = idsToAdd.length;

  setState(prev => ({
    ...prev,
    activeTabId: tabId,  // 自动切换到目标标签页
    tabs: prev.tabs.map(tab =>
      tab.id === tabId
        ? { ...tab, selectedFileIds: [...tab.selectedFileIds, ...idsToAdd] }
        : tab
    )
  }));

  // 显示提示
  if (actuallyAdded < imageIds.length) {
    showToast(t('context.partiallyAdded')?.replace('{added}', String(actuallyAdded)).replace('{total}', String(imageIds.length)) 
      || `已添加 ${actuallyAdded}/${imageIds.length} 张图片（画布已满）`);
  } else {
    showToast(t('context.addedToCanvas') || '已添加到画布');
  }
}, [state.tabs, setState, showToast, t]);
```

#### ImageComparer 组件调用修改

**onReady 回调修改**:

原代码:
```typescript
onReady={() => updateTabById(tab.id, { selectedFileIds: [] })}
```

新代码:
```typescript
onReady={() => {
  // 图片加载完成后的回调，不需要清空 selectedFileIds
  // 保留此回调用于未来可能的用途
}}
```

**修改原因**: 原代码在图片加载完成后清空 `selectedFileIds`，导致画布显示为空。

#### ContextMenu 组件调用修改

新增 props:
```typescript
tabs={state.tabs}
handleAddToCompareCanvas={handleAddToCompareCanvas}
```

---

### 4. translations.ts

#### 新增翻译键值

**中文 (zh)**:
```typescript
addToCanvas: '添加到 "{name}"',
newCanvas: '新建画布',
canvasFull: '画布已满',
addedToCanvas: '已添加到画布',
partiallyAdded: '已添加 {added}/{total} 张图片（画布已满）',
```

**英文 (en)**:
```typescript
addToCanvas: 'Add to "{name}"',
newCanvas: 'New Canvas',
canvasFull: 'Canvas is full',
addedToCanvas: 'Added to canvas',
partiallyAdded: 'Added {added}/{total} images (canvas full)',
```

---

## 功能特性

### 1. 二级菜单显示逻辑
- 当存在图片对比标签页时，"图片对比"菜单项显示右箭头指示器
- 鼠标悬停时展开二级菜单
- 二级菜单显示所有现有画布及其当前图片数量

### 2. 画布容量显示
- 每个画布显示当前图片数量 / 最大容量 (24)
- 已满的画布 (24/24) 显示为禁用状态
- 部分添加时显示提示信息

### 3. 自动切换标签页
- 添加图片到画布后，自动切换到该画布标签页
- 画布立即显示新添加的图片

### 4. 边界处理
- 二级菜单超出屏幕右侧时显示在左侧
- 二级菜单超出屏幕底部时向上调整
- 使用 `fixed` 定位避免被父容器裁剪

---

## 问题修复记录

### 问题1: 二级菜单出现在底部并出现滚动条
**原因**: 二级菜单使用 `absolute` 定位，但父容器有 `max-h-[80vh] overflow-y-auto`  
**解决**: 改为 `fixed` 定位并手动计算位置

### 问题2: 画布为空，图片没有显示
**原因1**: `onReady` 回调清空 `selectedFileIds`  
**解决**: 移除清空逻辑

**原因2**: ImageComparer 不响应 `selectedFileIds` 变化  
**解决**: 修改 useEffect 监听 `selectedFileIds` 变化

### 问题3: 鼠标移动到二级菜单时菜单消失
**原因**: 鼠标移出父元素时触发 `onMouseLeave`  
**解决**: 二级菜单本身也添加悬停事件，保持打开状态

### 问题4: 二级菜单位置不正确
**原因**: 定位参考元素错误  
**解决**: 使用 ref 保存"图片对比"菜单项引用，相对于它定位

### 问题5: 点击图片对比画布时图片被清空
**原因**: `handleMouseUp` 函数中，当点击空白处时调用 `onSelect?.('')`，导致父组件的 `selectedFileIds` 被清空  
**解决**: 移除点击空白处时的 `onSelect('')` 调用

### 问题6: 单击/框选/右键图片时其他图片消失
**原因**: `handleMouseDown`、`handleMouseUp` 和 `handleContextMenu` 中都调用了 `onSelect`，导致父组件的 `selectedFileIds` 被覆盖为单个图片ID  
**解决**: 在图片对比模式下，所有鼠标交互都不再调用 `onSelect`，只更新内部状态 `activeImageIds`

### 问题7: 右键二级菜单中画布图片数量显示不正确
**原因**: `ImageComparer` 组件添加/移除图片时只更新了内部状态，没有更新父组件的 `selectedFileIds`  
**解决**: 
- 添加新 prop `onSelectedFileIdsChange?: (ids: string[]) => void`
- 在 `handleAddImages` 和 `handleRemoveImage` 中调用 `onSelectedFileIdsChange` 通知父组件

### 问题8: 画布名称显示异常（如"画布6mi7"）
**原因**: `handleOpenCompareInNewTab` 函数创建新标签页时没有设置 `sessionName`  
**解决**: 在 `useNavigation.ts` 中添加 `generateCanvasName` 函数，为新标签页生成正确的画布名称

### 问题9: 二级菜单鼠标悬停不稳定，容易消失
**原因**: 鼠标移出父元素时立即触发 `onMouseLeave`  
**解决**: 添加 `setTimeout` 延迟关闭机制（150ms），给用户足够时间移动到二级菜单

### 问题10: 右侧详情面板不显示当前选中图片的详情
**原因**: `ImageComparer` 组件使用内部的 `activeImageIds` 状态跟踪画布中选中的图片，但没有同步到父组件的 `selectedFileIds`，导致 `MetadataPanel` 始终显示最初传入的图片详情  
**解决**: 
- 添加 `useEffect` 监听 `activeImageIds` 变化
- 当 `activeImageIds` 变化时，调用 `onSelectedFileIdsChange` 同步更新父组件的 `selectedFileIds`
- 添加 `isInternalSelectionChangeRef` 标记，避免循环更新导致画布图片消失

**相关代码**:
```typescript
// 用于区分是外部 selectedFileIds 变化还是内部 activeImageIds 变化
const isInternalSelectionChangeRef = useRef(false);

// 当 activeImageIds 变化时，同步更新父组件的 selectedFileIds
useEffect(() => {
  // 标记为内部选择变化，避免触发 selectedFileIds 的 useEffect 重新初始化
  isInternalSelectionChangeRef.current = true;
  if (activeImageIds.length === 0) {
    onSelectedFileIdsChange?.([]);
  } else {
    onSelectedFileIdsChange?.(activeImageIds);
  }
}, [activeImageIds]);

// 在 selectedFileIds 的 useEffect 中跳过内部变化
useEffect(() => {
  if (!initializedRef.current) {
    initializedRef.current = true;
  }
  // 如果是内部选择变化导致的 selectedFileIds 更新，不重新初始化
  if (isInternalSelectionChangeRef.current) {
    isInternalSelectionChangeRef.current = false;
    return;
  }
  // ... 原有逻辑
}, [selectedFileIds]);
```

### 问题11: 画布图片消失（循环更新问题）
**原因**: 在修复问题10时，监听 `activeImageIds` 的 `useEffect` 调用 `onSelectedFileIdsChange` 更新父组件，父组件更新 `selectedFileIds` 后又触发了另一个 `useEffect`，将 `internalSelectedIds` 重置为 `selectedFileIds`（只有选中的图片），导致其他图片"消失"  
**解决**: 使用 `isInternalSelectionChangeRef` ref 标记来区分是内部选择变化还是外部 `selectedFileIds` 变化，在 `selectedFileIds` 的 `useEffect` 中检测到内部变化时直接返回，不重新初始化状态

---

## 测试建议

1. **无画布场景**: 确保没有画布时，选择2张以上图片可以直接创建新画布
2. **有画布场景**: 确保有画布时，二级菜单正确显示所有画布
3. **画布容量**: 测试画布满24张后，该画布显示为禁用状态
4. **部分添加**: 测试向接近满的画布添加多张图片时的部分添加提示
5. **菜单位置**: 测试在屏幕边缘打开菜单时，二级菜单正确调整位置
6. **图片显示**: 测试添加图片后，画布立即显示新图片

---

## 相关文件引用

- [右键菜单图片对比功能增强 - 设计文档](../.trae/documents/右键菜单图片对比功能增强.md)
- [ContextMenu.tsx](../src/components/ContextMenu.tsx)
- [ImageComparer.tsx](../src/components/ImageComparer.tsx)
- [App.tsx](../src/App.tsx)
- [translations.ts](../src/utils/translations.ts)
