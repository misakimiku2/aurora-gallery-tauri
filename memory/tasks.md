# 任务和开发计划

## ✅ 已完成：鼠标拖拽文件和文件夹功能

已实现以下功能：
- ✅ 在FileGrid中实现了拖拽事件处理（HTML5 Drag & Drop API）
- ✅ 在TreeSidebar中实现了拖拽放置处理，支持将文件拖拽到文件夹树状结构
- ✅ 在FileGrid主界面中实现了拖拽放置处理，支持将文件拖拽到显示的文件夹
- ✅ 在App.tsx中添加了拖拽完成后的状态同步逻辑
- ✅ 拖拽操作使用已有的handleMoveFiles函数处理文件移动

### 实现细节

#### 1. FileGrid组件拖拽支持
- FileCard组件实现了`draggable={true}`属性
- `onDragStart`事件设置拖拽数据（JSON格式包含file IDs和sourceFolderId）
- `handleDragOver`和`handleDrop`事件处理拖拽放置操作
- 支持拖拽到特定文件夹或空白区域（移动到当前目录）

#### 2. TreeSidebar组件拖拽支持
- TreeNode组件添加了`onDragOver`、`onDragLeave`和`onDrop`事件处理
- 拖拽悬停时显示视觉反馈（蓝色边框和高亮背景）
- 防止将文件夹拖拽到自己或子文件夹中

#### 3. 状态管理（App.tsx）
- 添加了`handleDropOnFolder`函数作为拖拽处理的统一入口
- 该函数调用已有的`handleMoveFiles`函数完成实际的文件移动操作
- 拖拽状态通过dragDropEnabled管理

### 备注（Tauri官方文档）
⚠️ **重要配置**：
- dragDropEnabled: 布尔值，webview上是否启用拖放功能
- **在Windows上，禁用此功能是使用前端HTML5拖放所必需的**
- 修改：在 `src-tauri/tauri.conf.json` 中的 `windows[0].dragDropEnabled` 设置为 `false`
- 这样才能让前端的HTML5 Drag & Drop API正常工作
- 否则会显示禁止符号（⛔），表示Tauri拦截了拖放事件

### CSS 样式增强（2025-12-23）
✅ 添加了明显的拖拽 UI 效果：

1. **拖拽中的文件**
   - 透明度：50%（opacity-50）
   - 缩放：95%（scale-95）
   - 阴影：增强的投影效果（drop-shadow-lg）
   - 边框：虚线蓝色边框（border-blue-400 border-2 dashed）
   - 背景：浅蓝色背景（bg-blue-50 / dark:bg-blue-900/20）

2. **拖拽悬停目标（文件夹）**
   - 脉冲动画：环形光圈从中心向外扩散（0.6s 周期）
   - 缩放：轻微放大至 102%
   - CSS 类：drop-target-active（在 onDragOver 时添加，onDragLeave 时移除）
   - 支持暗黑模式变体

3. **全局拖拽状态**
   - 渐变背景：从顶部蓝色逐渐透明（bg-gradient-to-b from-blue-50 to-transparent）
   - 虚线边框：蓝色虚线边框（border-2 border-dashed border-blue-300）
   - 平滑过渡：200ms 动画过渡（transition-all duration-200）
   - 暗黑模式适配

4. **拖拽预览升级为 Canvas 缩略图堆叠（2025-12-23 更新）**
   - 从 DOM 方案改用 Canvas 方案，避免 DOM 移除时机问题
   - 显示前 3 个文件的缓存缩略图，堆叠排列（旋转±8°）
   - 缩略图大小：单文件 100px，多文件 90px
   - 颜色：图片使用实际缓存缩略图，文件夹用蓝色渐变，其他用灰色
   - 边框：2px 白色半透明，增加玻璃感
   - 计数徽章：圆形蓝色徽章，右下角显示 "+N"
   - **异步加载**：等待所有缓存缩略图加载后再绘制，确保完整显示
   - **跟随鼠标**：setDragImage 设置中心点为 (60, 60)，预览正确跟随鼠标指针

相关文件：
- src/components/FileGrid.tsx（FileCard 拖拽状态管理和 Canvas 绘制）
- index.css（drop-target-pulse 动画和样式定义）
- memory/drag-drop-css-details.md（详细 CSS 文档）
- memory/drag-drop-css-quick-reference.md（快速参考指南）
- memory/drag-drop-thumbnail-improvements.md（缩略图堆叠文档）
- memory/drag-drop-canvas-implementation.md（Canvas 实现细节）
- memory/drag-drop-css-quick-reference.md（快速参考指南）

## 当前开发状态

### ✅ 已完成功能 (MVP)

#### 核心文件系统
- [x] 目录扫描和文件树构建
- [x] 多格式图片支持 (JPG, PNG, GIF, WebP, BMP, TIFF, ICO, SVG)
- [x] 文件操作 (复制、移动、重命名、删除)
- [x] 文件夹创建和管理
- [x] 虚拟文件系统架构

#### 图片处理
- [x] 高性能缩略图生成 (fast_image_resize + Rayon)
- [x] 智能缓存系统 (JPEG/WebP 自动选择)
- [x] 图片浏览器 (缩放、旋转、幻灯片)
- [x] 序列查看器 (GIF 帧查看)
- [x] 图片元数据提取 (尺寸、大小、格式)

#### AI 功能
- [x] 多提供商支持 (OpenAI, Ollama, LM Studio)
- [x] 图片分析 (物体、场景、颜色、人脸)
- [x] OCR 文字识别
- [x] 智能翻译
- [x] 人物识别和分组
- [x] 文件夹智能摘要
- [x] AI 智能搜索

#### 用户界面
- [x] 三栏布局 (侧边栏 + 主内容 + 元数据)
- [x] 多视图模式 (网格、列表)
- [x] 标签系统 (创建、编辑、筛选)
- [x] 人物管理 (创建、重命名、头像)
- [x] 设置面板 (主题、语言、AI 配置)
- [x] 上下文菜单
- [x] 任务进度显示
- [x] 多语言支持 (中文/英文)

#### 数据管理
- [x] 用户数据持久化
- [x] 自动保存机制
- [x] 缓存管理
- [x] 数据备份和恢复

#### 系统集成
- [x] 窗口控制 (最小化到托盘)
- [x] 文件管理器集成
- [x] 键盘快捷键
- [x] 托盘图标

## 待开发功能

### 🔧 短期优化 (1-2 周)

#### 性能优化
- [ ] 虚拟滚动实现 (大文件列表)
- [ ] 图片预加载策略
- [ ] 内存使用优化
- [ ] 启动速度优化

#### UI/UX 改进
- [ ] 空状态页面设计
- [ ] 加载状态优化
- [ ] 错误提示美化
- [ ] 批量操作界面
- [ ] 拖拽上传支持

#### 功能增强
- [ ] 高级搜索语法
- [ ] 保存搜索结果
- [ ] 智能文件夹 (虚拟文件夹)
- [ ] 收藏夹系统
- [ ] 最近访问记录

### 🚀 中期开发 (1-3 个月)

#### 高级图片功能
- [ ] 图片编辑器 (裁剪、旋转、滤镜)
- [ ] 批量图片处理
- [ ] 图片对比功能
- [ ] EXIF 数据查看
- [ ] 图片压缩优化

#### AI 功能增强
- [ ] 自动标签建议
- [ ] 智能相册分类
- [ ] 人脸识别优化
- [ ] 场景分类增强
- [ ] 自然语言查询优化

#### 数据管理
- [ ] 云同步功能
- [ ] 数据导出 (JSON, CSV)
- [ ] 数据导入
- [ ] 版本历史
- [ ] 回收站功能

#### 用户体验
- [ ] 欢迎向导
- [ ] 快速开始指南
- [ ] 键盘快捷键配置
- [ ] 主题自定义
- [ ] 无障碍支持

### 🎯 长期规划 (3-6 个月)

#### 架构扩展
- [ ] 插件系统
- [ ] API 接口
- [ ] 脚本支持
- [ ] 自动化工作流

#### 云和协作
- [ ] 云存储集成
- [ ] 多设备同步
- [ ] 分享功能
- [ ] 协作编辑
- [ ] 团队功能

#### 高级功能
- [ ] 视频支持
- [ ] 音频管理
- [ ] 文档管理
- [ ] 智能相册生成
- [ ] AI 创作辅助

#### 平台扩展
- [ ] 移动端应用
- [ ] Web 版本
- [ ] 浏览器扩展
- [ ] 命令行工具

## 技术债务

### 代码质量
- [ ] 单元测试覆盖
- [ ] 集成测试
- [ ] E2E 测试
- [ ] 代码注释完善
- [ ] 文档更新

### 性能监控
- [ ] 性能指标收集
- [ ] 错误监控
- [ ] 用户行为分析
- [ ] 资源使用统计

### 安全加固
- [ ] 输入验证增强
- [ ] 权限最小化
- [ ] 数据加密
- [ ] 安全审计

## Bug 修复清单

### 已知问题
- [ ] 大文件处理时内存占用过高
- [ ] 某些特殊字符文件名处理异常
- [ ] 网络不稳定时 AI 请求失败处理
- [ ] 快速切换标签页时状态同步问题
- [ ] 某些情况下缩略图生成失败

### 待验证问题
- [ ] 不同操作系统路径处理一致性
- [ ] 长时间运行的内存泄漏
- [ ] 并发操作的数据竞争
- [ ] 极端情况下的错误处理

## 里程碑计划

### Milestone 1: MVP 稳定版 (已完成)
- ✅ 核心功能完整
- ✅ 基础性能达标
- ✅ 用户体验基本流畅

### Milestone 2: 性能优化版 (当前)
- [ ] 性能显著提升
- [ ] UI/UX 大幅改善
- [ ] 稳定性增强

### Milestone 3: 功能增强版
- [ ] 高级图片功能
- [ ] AI 能力扩展
- [ ] 数据管理完善

### Milestone 4: 云同步版
- [ ] 云端集成
- [ ] 多设备同步
- [ ] 协作功能

### Milestone 5: 生态扩展版
- [ ] 插件系统
- [ ] 平台扩展
- [ ] 开放生态

## 开发优先级

### P0 (紧急)
- 性能优化和内存管理
- 关键 Bug 修复
- 数据安全加固

### P1 (重要)
- 用户体验改进
- AI 功能增强
- 高级图片处理

### P2 (一般)
- 功能扩展
- 云同步
- 插件系统

### P3 (未来)
- 平台扩展
- 协作功能
- 生态建设

## 资源需求

### 开发资源
- **前端开发**: React + TypeScript 专家
- **后端开发**: Rust + Tauri 专家
- **UI/UX 设计**: 现代化界面设计
- **测试**: 自动化测试工程师

### 基础设施
- **构建服务器**: CI/CD 流水线
- **测试环境**: 多平台测试
- **监控系统**: 性能和错误监控
- **文档系统**: 在线文档和帮助

### 第三方服务
- **AI API**: OpenAI, 可能的其他提供商
- **云存储**: 用于同步功能
- **分析工具**: 用户行为分析
- **错误追踪**: Sentry 或类似服务

## 成功指标

### 技术指标
- 启动时间 < 2 秒
- 图片加载 < 500ms
- 内存使用 < 500MB (常规操作)
- 崩溃率 < 0.1%

### 用户指标
- 用户留存率 > 60%
- 功能使用率 > 40%
- 用户满意度 > 4.5/5
- NPS > 50

### 业务指标
- 月活跃用户 > 10,000
- 付费转化率 > 5%
- 社区贡献 > 100 PRs

---

*本文档作为项目的开发路线图，将持续更新以反映实际开发进度和优先级变化。*